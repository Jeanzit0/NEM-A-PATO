<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEM A PAU - Ultimate Online</title>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
  body { margin: 0; padding: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
  #players { position: absolute; top: 20px; right: 20px; border: 1px solid #fff; padding: 15px; text-align: right; font-size: 0.9em; min-width: 150px; z-index: 10; background: rgba(0,0,0,0.8); }
  #chat-container { position: absolute; bottom: 20px; left: 20px; width: 320px; height: 300px; border: 1px solid #fff; background: rgba(0,0,0,0.9); display: none; flex-direction: column; z-index: 100; }
  #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 0.85rem; text-align: left; }
  #chat-input { background: #111; border: none; border-top: 1px solid #fff; color: #fff; padding: 12px; width: 100%; box-sizing: border-box; outline: none; }
  #app { width: 100%; display: flex; justify-content: center; }
  .center { text-align: center; max-width: 650px; width: 90%; }
  .logo { font-family: 'Impact', sans-serif; font-size: 3.5rem; letter-spacing: 5px; border: 4px solid #fff; padding: 10px 20px; display: inline-block; margin-bottom: 25px; }
  
  input { background: #000; color: #fff; border: 1px solid #fff; padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; text-align: center; font-size: 1.2rem; }
  button { background: #fff; color: #000; border: 1px solid #fff; padding: 12px; cursor: pointer; font-weight: bold; text-transform: uppercase; width: 100%; transition: 0.2s; margin-top: 15px; }
  .btn-nemapau { background: none; color: #ff4d4d; border-color: #ff4d4d; margin-top: 30px; font-size: 1.5rem; }
  
  .pergunta-texto { font-size: 1.4rem; margin-top: 20px; font-weight: bold; }
  .unidade-texto { font-size: 1rem; color: #aaa; margin-bottom: 20px; }
  .resultado-box { border-top: 1px solid #fff; margin-top: 20px; padding-top: 20px; line-height: 1.6; }
  .ganhou-ponto { color: #ff4d4d; font-weight: bold; }
  .nao-marcou { color: #2ecc71; font-weight: bold; }
  
  /* Animação Logo */
  .flash-logo { font-size: 5rem; font-family: 'Impact'; color: #ff4d4d; animation: pulse 0.5s infinite; }
  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
</style>
</head>
<body>

<div id="players"></div>
<div id="app"></div>

<div id="chat-container">
  <div style="padding: 5px; background: #222; font-size: 0.7rem; text-align: center; border-bottom: 1px solid #444;">DIGITE /join NOME_DA_SALA</div>
  <div id="chat-messages"></div>
  <input type="text" id="chat-input" placeholder="Mensagem ou comando..." onkeydown="if(event.key==='Enter') tratarChat()">
</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBLfN4uLs6L1_XnSSdpIbhrPKBSreAtK_8",
    authDomain: "nemapau-47956.firebaseapp.com",
    databaseURL: "https://nemapau-47956-default-rtdb.firebaseio.com/",
    projectId: "nemapau-47956",
    storageBucket: "nemapau-47956.firebasestorage.app",
    messagingSenderId: "575679805707",
    appId: "1:575679805707:web:768cf1108ede446f710a0e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const bancoPerguntasOriginal = [
  { texto: "Distância média da Terra à Lua", unidade: "km", resposta: 384400 },
  { texto: "Altura do Monte Everest", unidade: "m", resposta: 8849 },
  { texto: "População do Brasil (Censo 2022)", unidade: "pessoas", resposta: 203062512 },
  { texto: "Velocidade da luz no vácuo", unidade: "km/s", resposta: 299792 },
  { texto: "Quantidade de ossos no humano adulto", unidade: "ossos", resposta: 206 }
];

let state = {
  tela: "inicial",
  jogadores: [],
  meuNome: "",
  souHost: false,
  salaId: null,
  jogadorDaVez: null,
  pergunta: null,
  valorAtual: null,
  ultimoJogador: null,
  revelacao: null // Para armazenar dados da dúvida
};

function tratarChat() {
  const input = document.getElementById("chat-input");
  const msg = input.value.trim();
  if (!msg) return;

  if (msg.startsWith("/")) {
    const partes = msg.split(" ");
    const cmd = partes[0].toLowerCase();

    if (cmd === "/join") {
      conectarASala(partes[1]);
    } else if (cmd === "/limparcache") {
      const senha = prompt("Senha Admin:");
      if (senha === "jean24gs") {
        db.ref('salas').remove();
        alert("Cache de salas limpo!");
        location.reload();
      }
    } else {
      const senha = prompt("Senha Admin:");
      if (senha === "jean24gs") executarComandoAdmin(msg);
    }
  } else {
    enviarMensagemChat(msg);
  }
  input.value = "";
}

function conectarASala(id) {
  if (!id) return alert("Uso: /join nome_da_sala");
  if (state.salaId) { db.ref(`salas/${state.salaId}/estado`).off(); db.ref(`salas/${state.salaId}/chat`).off(); }

  state.salaId = id.toLowerCase();
  const estadoRef = db.ref(`salas/${state.salaId}/estado`);

  estadoRef.on('value', (snap) => {
    const onlineState = snap.val();
    if (onlineState) {
      Object.assign(state, onlineState);
      state.souHost = (state.jogadores[0]?.nome === state.meuNome);
      render();
    } else {
      if (state.meuNome) {
        state.tela = "espera";
        state.jogadores = [{ nome: state.meuNome, pontos: 0, humano: true }];
        salvarEstadoGlobal();
      }
    }
  });

  db.ref(`salas/${state.salaId}/chat`).on('child_added', (snap) => {
    const m = snap.val();
    exibirNoChat(m.autor, m.texto);
  });

  estadoRef.once('value', (snap) => {
    let currentData = snap.val() || { tela: "espera", jogadores: [] };
    if (!currentData.jogadores.find(j => j.nome === state.meuNome)) {
      currentData.jogadores.push({ nome: state.meuNome, pontos: 0, humano: true });
      estadoRef.set(currentData);
    }
  });
}

function enviarMensagemChat(texto) {
  if (!state.salaId) return;
  db.ref(`salas/${state.salaId}/chat`).push({ autor: `<strong>${state.meuNome}</strong>`, texto: texto });
}

function exibirNoChat(autor, texto) {
  const box = document.getElementById("chat-messages");
  box.innerHTML += `<div>${autor}: ${texto}</div>`;
  box.scrollTop = box.scrollHeight;
}

function salvarEstadoGlobal() {
  if (state.salaId) db.ref(`salas/${state.salaId}/estado`).set(state);
}

function render() {
  if (state.tela !== "inicial" && !state.meuNome) { location.reload(); return; }
  const app = document.getElementById("app");
  const playersDiv = document.getElementById("players");
  const chatCont = document.getElementById("chat-container");
  app.innerHTML = "";
  const box = document.createElement("div"); box.className = "center"; app.appendChild(box);

  if (state.tela === "inicial") {
    playersDiv.style.display = "none"; chatCont.style.display = "none";
    box.innerHTML = `<div class="logo">NEM A PAU</div><input id="nInp" placeholder="SEU NOME"><button onclick="registrar()">ENTRAR</button>`;
    return;
  }

  playersDiv.style.display = "block"; chatCont.style.display = "flex";
  playersDiv.innerHTML = `<strong>SALA: ${state.salaId.toUpperCase()}</strong><br><hr>` + state.jogadores.map(j => `<div>${j.nome}: ${j.pontos}</div>`).join("");

  if (state.tela === "instrucao") {
    box.innerHTML = `<h2>BEM-VINDO, ${state.meuNome}!</h2><p>Acesse uma sala para jogar.</p><p style="color:#ff4d4d">Digite <strong>/join nome_da_sala</strong> no chat à esquerda para conectar.</p>`;
  }

  if (state.tela === "espera") {
    box.innerHTML = `<h2>SALA DE ESPERA</h2>` + state.jogadores.map(j => `<div>• ${j.nome}</div>`).join("") + (state.souHost ? `<button onclick="iniciarJogo()">INICIAR JOGO</button>` : `<p><small>Aguardando Host...</small></p>`);
  }

  if (state.tela === "jogo") {
    const jVez = state.jogadorDaVez;
    box.innerHTML = `<div>VEZ DE: <strong>${jVez.nome.toUpperCase()}</strong></div>
      <div class="pergunta-texto">${state.pergunta.texto}</div>
      <div class="unidade-texto">Unidade: ${state.pergunta.unidade}</div>
      ${state.valorAtual ? `<p>Palpite atual: <strong>${state.valorAtual}</strong></p>` : ""}
      ${jVez.nome === state.meuNome ? `
        <input id="chInp" type="number" placeholder="Chute maior que ${state.valorAtual || 0}">
        <button onclick="enviarPalpite()">CHUTAR</button>
        ${state.valorAtual ? `<button class="btn-nemapau" onclick="animarDuvida()">NEM A PAU!</button>` : ""}
      ` : `<p>Aguardando ${jVez.nome}...</p>`}`;
  }

  if (state.tela === "nemapau_flash") {
    box.innerHTML = `<div class="flash-logo">NEM A PAU!</div>`;
  }

  if (state.tela === "revelacao") {
    const r = state.revelacao;
    box.innerHTML = `
      <div class="pergunta-texto">${state.pergunta.texto}</div>
      <div class="unidade-texto">${state.pergunta.unidade}</div>
      <div style="font-size: 2rem; margin: 10px 0;">Resposta: <strong>${state.pergunta.resposta}</strong></div>
      <div class="resultado-box">
        <div class="${r.ultimoGanhou ? 'ganhou-ponto' : 'nao-marcou'}">${r.ultimoNome} ${r.ultimoGanhou ? 'ganhou um ponto' : 'não marcou ponto nesta rodada'}</div>
        <div class="${r.duvidouGanhou ? 'ganhou-ponto' : 'nao-marcou'}">${r.duvidouNome} ${r.duvidouGanhou ? 'ganhou um ponto' : 'não marcou ponto nesta rodada'}</div>
      </div>
    `;
  }
}

function registrar() {
  const n = document.getElementById("nInp").value.trim();
  if (!n) return;
  state.meuNome = n; state.tela = "instrucao";
  document.getElementById("chat-container").style.display = "flex";
  render();
}

function iniciarJogo() {
  const p = bancoPerguntasOriginal[Math.floor(Math.random() * bancoPerguntasOriginal.length)];
  salvarEstadoGlobalCom({ tela: "jogo", pergunta: p, jogadorDaVez: state.jogadores[0], valorAtual: null, ultimoJogador: null });
}

function enviarPalpite() {
  const v = Number(document.getElementById("chInp").value);
  if (state.valorAtual && v <= state.valorAtual) return alert("Chute deve ser maior!");
  const idx = state.jogadores.findIndex(j => j.nome === state.jogadorDaVez.nome);
  salvarEstadoGlobalCom({ valorAtual: v, ultimoJogador: state.jogadorDaVez, jogadorDaVez: state.jogadores[(idx + 1) % state.jogadores.length] });
}

function animarDuvida() {
  const correta = state.pergunta.resposta;
  const chute = state.valorAtual;
  const ultimoNome = state.ultimoJogador.nome;
  const duvidouNome = state.meuNome;
  
  // Lógica de pontos: Se chute > resposta, quem chutou ganha ponto. Se chute < resposta, quem duvidou ganha.
  const ultimoGanhou = chute > correta;
  const duvidouGanhou = chute <= correta;

  let novosJogadores = state.jogadores.map(j => {
    if (ultimoGanhou && j.nome === ultimoNome) j.pontos++;
    if (duvidouGanhou && j.nome === duvidouNome) j.pontos++;
    return j;
  });

  const infoRevelacao = { ultimoNome, duvidouNome, ultimoGanhou, duvidouGanhou };

  // Fase 1: Flash Nem a Pau (3s)
  salvarEstadoGlobalCom({ tela: "nemapau_flash", jogadores: novosJogadores });

  setTimeout(() => {
    // Fase 2: Revelação (8s)
    salvarEstadoGlobalCom({ tela: "revelacao", revelacao: infoRevelacao });
    
    setTimeout(() => {
        // Fase 3: Próxima Rodada
        const novaP = bancoPerguntasOriginal[Math.floor(Math.random() * bancoPerguntasOriginal.length)];
        salvarEstadoGlobalCom({ tela: "jogo", pergunta: novaP, valorAtual: null, revelacao: null });
    }, 8000);
  }, 3000);
}

function salvarEstadoGlobalCom(obj) {
  Object.assign(state, obj);
  if (state.salaId) db.ref(`salas/${state.salaId}/estado`).set(state);
}

render();
</script>
</body>
</html>